<!DOCTYPE html>
<!--    
    This file is part of OpenNotebook-Web

    OpenNotebook-Web is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    OpenNotebook-Web is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with OpenNotebook-Web.  If not, see <http://www.gnu.org/licenses/>. 
-->
<html>
<head>
<!-- http://paletton.com/#uid=13u0u0kllllaFw0g0qFqFg0w0aF --> 

<meta name="viewport" content="width=624">
<title>Open Notebook</title>

<link rel="stylesheet" type="text/css" href="../build/mathquill.css">
<link rel="stylesheet" type="text/css" href="support/home.css">
<!-- testing -->
<script src="../expect.min.js"></script>

<!-- UI react-->
<script src="react/build/react.min.js"></script>
<script src="react/build/react-dom.min.js"></script>

<script src="../babel.min.js"></script>
<!-- input sanitiation --> 
<!-- script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.2/marked.min.js"></script -->

<!-- Only use this for MathQuill! --> 
<script type="text/javascript" src="support/jquery-1.7.2.js"></script>

<script type="text/javascript" src="../build/mathquill-basic.js"></script>
<!-- App state management -->
<script type="text/javascript" src="../redux.js"></script>
<script type="text/javascript" src="../lodash.min.js"></script>
<script type="text/babel">

// copied from here, didn't seem worth adding a dependency, I'm sure the JS people will cure me of that eventually...
// https://github.com/substack/deep-freeze/blob/master/index.js
function deepFreeze (o) {
  Object.freeze(o);

  Object.getOwnPropertyNames(o).forEach(function (prop) {
    if (o.hasOwnProperty(prop)
    && o[prop] !== null
    && (typeof o[prop] === "object" || typeof o[prop] === "function")
    && !Object.isFrozen(o[prop])) {
      deepFreeze(o[prop]);
    }
  });
  
  return o;
};

//Learning Redux

const UNTITLED_ASSINGMENT = 'Untitled Assignment';

// Application state properties
// TODO - use these as the actual keys in object literals in the reducer
// when I have ES6 and Babel

// Redux things
var type = 'type';

// Application modes
var APP_MODE = 'APP_MODE';
var EDIT_ASSIGNMENT = 'EDIT_ASSIGNMENT';
var GRADE_ASSIGNMENTS = 'GRADE_ASSIGNMENTS';

// Assignment properties
var ASSIGNMENT_NAME = 'ASSIGNMENT_NAME';
var PROBLEMS = 'PROBLEMS';

// Problem properties
var PROBLEM_NUMBER = 'PROBLEM_NUMBER';
var STEPS = 'STEPS';

// actions
var ADD_PROBLEM = 'ADD_PROBLEM';
// remove problem expects an "index" property 
// specifying which problem to remove
var REMOVE_PROBLEM = 'REMOVE_PROBLEM';

// this action expects:
// problemIndex - for which problem to change
// newProblemNumber - string with problem number, not a numberic
//                    type because the problem might be 1.a, etc.
var PROBLEM_INDEX = 'PROBLEM_INDEX';
var NEW_PROBLEM_NUMBER = 'NEW_PROBLEM_NUMBER';
var SET_PROBLEM_NUMBER = 'SET_PROBLEM_NUMBER';

// key used to refer to one step in a series of student work
var STEP_INDEX = 'STEP_INDEX';
// key used to refer to data to place at a given step
// currently will just be a string with latex, but may change
// type if other metadata needs to be stored with each step
// such as a flag the student could set to indicate more than
// 1 final answer
var NEW_STEP_CONTENT = 'NEW_STEP_CONTENT';

// this action expects:
// PROBLEM_INDEX - for which problem to change
// STEP_INDEX - index into the work steps for the given problem
// NEW_STEP_CONTENT - string for the new expression to write in this step
var EDIT_STEP = 'EDIT_STEP';
// TODO - decide if I want to add a feature to splice in
// a new step partway through a current problem
// this action expects an index for which problem to change
var NEW_STEP = 'NEW_STEP';
// this action expects an index for which problem to change
var UNDO_STEP = 'UNDO_STEP';
// this action expects an index for which problem to change
var REDO_STEP = 'REDO_STEP';

function problem(problem, action) {
    if (problem === undefined) {
        return { PROBLEM_NUMBER : '', STEPS : [''] };
    } else if (action.type === SET_PROBLEM_NUMBER) {
        var newNamedProb = _.clone(problem)
        newNamedProb[PROBLEM_NUMBER] = action[NEW_PROBLEM_NUMBER];
        return newNamedProb;
    } else  if (action.type === EDIT_STEP) {
        
// PROBLEM_INDEX - for which problem to change
// STEP_INDEX - index into the work steps for the given problem
// NEW_STEP_CONTENT - string for the new expression to write in this step
    } else if (action.type === NEW_STEP) {
    } else {
        return problem;
    }
}

function problems(probList, action) {
    if (probList === undefined) {
        return [ { PROBLEM_NUMBER : "", STEPS : [""] } ];
    }

    if (action.type === ADD_PROBLEM) {
        return _.clone(probList).concat(problem(undefined, action));
    } else if (action.type === REMOVE_PROBLEM) {
        return [
            ...probList.slice(0, action.PROBLEM_INDEX),
            ...probList.slice(action.PROBLEM_INDEX + 1)
        ];
    } else if (action.type === SET_PROBLEM_NUMBER ||
               action.type === EDIT_STEP ||
               action.type === NEW_STEP) {
        return [ 
            ...probList.slice(0, action.PROBLEM_INDEX),
            problem(probList[action.PROBLEM_INDEX], action),
            ...probList.slice(action.PROBLEM_INDEX + 1)
        ]
    } else {
        return probList;
    }
}

function assignment(state, action) {
    if (state === undefined) {
        return {
            APP_MODE : EDIT_ASSIGNMENT,
            ASSIGNMENT_NAME : UNTITLED_ASSINGMENT,
            PROBLEMS : problems(undefined, action)
        }
    } else {
        var new_state = _.clone(state);
        new_state[PROBLEMS] = problems(new_state[PROBLEMS], action); 
        return new_state;
    }
}

var createStore = Redux.createStore;
var store = createStore(assignment);

function render() {
    console.log(document);
    ReactDOM.render(
        <OpenNotebook value={store.getState()} />,
        document.getElementById('root')
    );
}

var OpenNotebook = React.createClass({
  render: function() {
    console.log(this.props);
    // TODO - figure out how to best switch between teacher and
    // student mode rendering
    if (this.props.value[APP_MODE] === EDIT_ASSIGNMENT) {
        return (
            <div className="problem-container" style={{float:'none',overflow: 'hidden'}}>
                <div>Problem number <input type="text" className="problem-number"/></div>
                <br/>
                <div style={{float:'left'}}>
                    <p> Actions </p>
                    <input type="submit" className="next-step" name="next step" value="next step (ctrl-e)"/> <br/>
                    <input type="submit" className="undo-step" name="undo step" value="undo step (ctrl-z)"/> <br/>
                    <input type="submit" className="redo-step" name="redo step" value="redo step (ctrl-shift-z)"/>
                </div>
                    <div style={{float:'left'}} className="equation-list">
                    <p> Type math here </p>
                </div>
            </div>
        );
    }
  }
});

store.subscribe(render);
$(function() {
    render();
});

function testAddProblem() {
    var initialAssignment = {
        APP_MODE : EDIT_ASSIGNMENT,
        ASSIGNMENT_NAME : UNTITLED_ASSINGMENT,
        PROBLEMS : [ { PROBLEM_NUMBER : "1", STEPS : ["1+2", "3"] },
                     { PROBLEM_NUMBER : "2", STEPS : ["4-2", "2"] }
        ]
    }
    var expectedAssignment = {
        APP_MODE : EDIT_ASSIGNMENT,
        ASSIGNMENT_NAME : UNTITLED_ASSINGMENT,
        PROBLEMS : [ { PROBLEM_NUMBER : "1", STEPS : ["1+2", "3"] },
                     { PROBLEM_NUMBER : "2", STEPS : ["4-2", "2"] },
                     { PROBLEM_NUMBER : "", STEPS : [""] }
        ]
        
    }
    deepFreeze(initialAssignment);
    expect(
        assignment(initialAssignment, { type : ADD_PROBLEM })
    ).toEqual(expectedAssignment);
}

function testRemoveProblem() {
    var initialAssignment = {
        APP_MODE : EDIT_ASSIGNMENT,
        ASSIGNMENT_NAME : UNTITLED_ASSINGMENT,
        PROBLEMS : [ { PROBLEM_NUMBER : "1", STEPS : ["1+2", "3"] },
                     { PROBLEM_NUMBER : "2", STEPS : ["4-2", "2"] }
        ]
    }
    var expectedAssignment = {
        APP_MODE : EDIT_ASSIGNMENT,
        ASSIGNMENT_NAME : UNTITLED_ASSINGMENT,
        PROBLEMS : [ { PROBLEM_NUMBER : "1", STEPS : ["1+2", "3"] } ]
    }
    deepFreeze(initialAssignment);
    expect(
        assignment(initialAssignment, { type : REMOVE_PROBLEM, PROBLEM_INDEX : 1 })
    ).toEqual(expectedAssignment);
}

function testRenameProblem() {
    var initialAssignment = {
        APP_MODE : EDIT_ASSIGNMENT,
        ASSIGNMENT_NAME : UNTITLED_ASSINGMENT,
        PROBLEMS : [ { PROBLEM_NUMBER : "1", STEPS : ["1+2", "3"] },
                     { PROBLEM_NUMBER : "2", STEPS : ["4-2", "2"] }
        ]
    }
    var expectedAssignment = {
        APP_MODE : EDIT_ASSIGNMENT,
        ASSIGNMENT_NAME : UNTITLED_ASSINGMENT,
        PROBLEMS : [ { PROBLEM_NUMBER : "1", STEPS : ["1+2", "3"] },
                     { PROBLEM_NUMBER : "1.a", STEPS : ["4-2", "2"] }
        ]
    }
    deepFreeze(initialAssignment);
    expect(
        assignment(initialAssignment, { type : SET_PROBLEM_NUMBER, PROBLEM_INDEX : 1, NEW_PROBLEM_NUMBER : "1.a"})
    ).toEqual(expectedAssignment);
}

// Run tests
// TODO - seperate these from app code
testAddProblem();
testRemoveProblem();
testRenameProblem();

</script>
</head>
<body>
<div id="root"></div>
</body>
</html>
